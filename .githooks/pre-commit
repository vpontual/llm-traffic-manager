#!/bin/sh
set -eu

find_npm() {
  if command -v npm >/dev/null 2>&1; then
    command -v npm
    return 0
  fi

  # Git hooks run in non-interactive shells, so NVM may not be loaded.
  NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
  if [ -s "$NVM_DIR/nvm.sh" ]; then
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh"
    if [ -f ".nvmrc" ]; then
      nvm use --silent >/dev/null 2>&1 || true
    fi
  fi

  if command -v npm >/dev/null 2>&1; then
    command -v npm
    return 0
  fi

  for npm_path in "$HOME/.nvm/versions/node"/*/bin/npm; do
    if [ -x "$npm_path" ]; then
      echo "$npm_path"
      return 0
    fi
  done

  return 1
}

if ! NPM_BIN="$(find_npm)"; then
  echo "[pre-commit] npm not found. Ensure Node/npm is installed and accessible to Git hooks." >&2
  exit 127
fi

export PATH="$(dirname "$NPM_BIN"):$PATH"
echo "[pre-commit] Running checks..."
"$NPM_BIN" run check
